---
title: "Chapter 4. Linear Models"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(glue)
library(conflicted)
library(rethinking)
library(patchwork)
library(tidyverse)

theme_set(theme_minimal())

conflict_prefer("filter", "dplyr")

set.seed(0)
```

- this chapter introduce linear regresssion as a Bayesian procedure
    * under a probability interpretation (necessary for Bayesian word), linear reg. uses a Gaussian distribution for uncertainty about the measurement of interest

## 4.1 Why normal distributions are normal

- example:
    * you have 1,000 people stand at the half-way line of a soccer field
    * they each flip a coin 16 times, moving left if the coin comes up heads, and right if it comes up tails
    * the final distribution of people around the half-way line will be Gaussian even though the underlying model is binomial

### 4.1.1 Normal by addition

- we can simulate the above example
    * to show that the underlying coin-flip is nothing special, we will instead use a random values between -1 and 1 for each person to step

```{r}
pos <- replicate(1e3, sum(runif(16, -1, 1)))
plot(density(pos))
```

```{r}
set.seed(0)

n_steps <- 16

position_data <- tibble(person = 1:1e3) %>%
    mutate(position = purrr::map(person, ~ c(0, cumsum(runif(n_steps, -1, 1))))) %>%
    unnest(position) %>%
    group_by(person) %>%
    mutate(step = 0:n_steps) %>%
    ungroup()

walks_plot <- position_data %>%
    ggplot(aes(x = step, y = position, group = person)) +
    geom_line(alpha = 0.2, size = 0.1, color = "dodgerblue") +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    labs(x = "step", y = "position", 
         title = "Random-walks")

step_densities <- position_data %>%
    filter(step %in% c(4, 8, 16)) %>%
    ggplot(aes(x = position)) +
    facet_wrap(~ step, scales = "free_y", nrow = 1) +
    geom_density(fill = "grey90", color = "grey40") +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = expansion(mult = c(0, 0.02))) +
    labs(x = "position",
         y = "density",
         title = "Position distribution at several steps")

walks_plot / step_densities + plot_layout(heights = c(3, 2))
```

### 4.1.2 Normal by multiplication

- another example of how to get a normal distribution:
    * the growth rate of an organism is influenced by a dozen loci, each with several alleles that code for more growth
    * suppose that these loci interact with one another, and each increase growth by a percentage
    * therefore, their effects multiply instead of add
    * below is a simulation of sampling growth rates
    * this distribution is approximately normal because the multiplication of small numbers is approximately the same as addition
```{r}
# A single growth rate
prod(1 + runif(12, 0, 0.1))

growth <- replicate(1e4, prod(1 + runif(12, 0, 0.1)))
dens(growth, norm.comp = TRUE)
```

### 4.1.3 Normal by log-multiplication

- large deviates multiplied together produce Gaussian distributions on the log-scale

```{r}
growth <- replicate(1e4, prod(1 + runif(12, 0, 0.5)))
dens(growth, norm.comp = TRUE, main = "Not scaled")
dens(log(growth), norm.comp = TRUE, main = "Log-scaled")
```

### 4.1.4 Using Gaussian distributions

- we will build models of measurements as aggregations of normal distributions
- this is appropriate because:
    * the world is full of approximately normal distributions
    * we often are quite ignorant of the underlying distribution so modeling it as a mean and variance is often the best we can do


## 4.2 A language for describing models

